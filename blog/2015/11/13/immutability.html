<!DOCTYPE html>
<html lang="en">

  




<head>
  <title>
  
     Immutability, State, and Functions
  
</title>


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="
  Let’s start with the obligatory call to authority:
">

  <meta name="author" content="Dave Thomas (pragdave)">

  <meta property="og:description"
        content="
  Let’s start with the obligatory call to authority:
">
  <meta property="og:site_name"
        content="
  
     Immutability, State, and Functions
  
">
  <meta property="og:type"
        content="website">
  <meta property="og:url"
        content="
  https://pragdave.me/blog/2015/11/13/immutability.html
">
  <meta property="og:title"
        content="
  
     Immutability, State, and Functions
  
">


  <meta name="twitter:card"        content="summary">
  <meta name="twitter:description" content="
  Let’s start with the obligatory call to authority:
">
  <meta name="twitter:url"         content="
  https://pragdave.me/blog/2015/11/13/immutability.html
">
  <meta name="twitter:site"        content="pragdave">

  <link rel="shortcut icon"
        href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon"
        href="/assets/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="57x57"
        href="/assets/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="72x72"
        href="/assets/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="76x76"
        href="/assets/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon" sizes="114x114"
        href="/assets/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="120x120"
        href="/assets/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="144x144"
        href="/assets/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152"
        href="/assets/apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180"
        href="/assets/apple-touch-icon-180x180.png" />
  
  <title>
  
     Immutability, State, and Functions
  
</title>
  <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">

  <link rel="canonical"
        href="
  https://pragdave.me/blog/2015/11/13/immutability.html
">

  <link type="application/atom+xml" rel="alternate" href="https://pragdave.me/feed.xml" title="pragdave—the coding gnome" />

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
  


  <link type="text/css" rel="stylesheet" href="/assets/app.css">

</head>

  <script type="text/javascript" src="/assets/vendor.js"></script>
  <script type="text/javascript" src="/assets/vendor/drumknott-0.2.0.js"></script>
  <script type="text/javascript" src="/assets/application.js"></script>

  <body>

    <div class="container">
      <header class="main-header">
  <div class="row bar">
    <div class="col-xs-12 heading-box">
      <a href="/" title="Return to the main site">
        <span class="logo"></span>
      </a>
      <h1>Immutability, State, and Functions</h1>

      <nav id="search-trigger" role="search">
        <button type="button"
                class="btn btn-primary"
                data-toggle="modal"
                data-target="#search-box"
                aria-label="popup search box">
          <i class="fa fa-search" ></i>
          <span class="word" >search</span>
        </button>
      </nav>

    </div>
  </div>
  <div class="row mh-slug">
    <h3 class="col-xs-12">code better • have fun</h3>
  </div>

  <div class="modal fade"
     id="search-box"
     tabindex="-1"
     role="dialog"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <form id="search-form">
          <input type="text" class="form-control"
                 placeholder="search for…"
                 id="search-text"
                 aria-describedby="search-button">
            </button>
        </form>
        <div id="search-failed" style="display: none" >
          No matches found
        </div>
        <div id="search-results" style="display: none" >
          <ul>
          </ul>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" id="search-button" class="btn btn-primary">Search</button>
      </div>
    </div>
  </div>
</div>




</header>





      <main role="main" aria-label="Content">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="row">
    <div class="col-md-4">
      <div class="related" >
        <h4>You might like:</h4>
        

<ul class="related">
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  
  
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li>
      <a href="/blog/2018/06/02/project-structure.html">
        <small>02 Jun 2018</small>
        Project Structure Fire
      </a>
  </li>
  
  
  

  
  
  
  
  
  
  
  
  <li>
      <a href="/blog/2018/04/04/moving-back-to-linux.html">
        <small>04 Apr 2018</small>
        Moving Back to Linux
      </a>
  </li>
  
  
  

  
  
  
  
  
  
  
  
  <li>
      <a href="/blog/2018/01/28/dynamic-supervisors.html">
        <small>28 Jan 2018</small>
        Dynamix Supervisors replace :simple_one_for_one
      </a>
  </li>
  
  
  
  
  
</ul>

      </div>
    </div>
    <div class="col-md-8">
      <p class="post-meta">
        <time datetime="2015-11-13T00:00:00-06:00" itemprop="datePublished">Nov 13, 2015
        </time>
         | 
        
        

      </p>

      <div class="post-content" itemprop="articleBody">
        <p>Let’s start with the obligatory call to authority:</p>

<blockquote>
  <p>In functional programming, programs are executed by evaluating expressions, in contrast with imperative programming where programs are composed of statements which change global state when executed. Functional programming typically avoids using mutable state.</p>

  <p><cite>https://wiki.haskell.org/Functional_programming</cite></p>
</blockquote>

<p>Well, that seems pretty definitive. “Functional programming typically avoids mutable state.” Seems pretty clearcut.</p>

<p>But it’s wrong.</p>

<p>Explaining why I thing that will involve a trip down the path I’ve been exploring over the last year or so, as I have tried to crystalize my thinking on the new styles of programming, and the role of transformation as both a top-down and bottom-up coding and design technique.</p>

<p>Let’s start by thinking about state.</p>

<h2 id="where-does-a-program-keep-its-state">Where Does a Program Keep Its State?</h2>

<p>Programs run on computers, and at the lowest level their model of computation is tied to that of the machines on which the execute. Down at that low level, the state of a program is the state of the computer—the values in memory and the values in registers.[^fn:sideeffect] Some of those registers are used internally by the processor for housekeeping. Perhaps the most important of these is the program counter (PC). You can think of the PC as a pointer to the next instruction to execute.</p>

<p>We can take this up a level.  Here’s a simple program:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="sd">"</span><span class="s2">Cat"</span>
<span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">downcase</span>       <span class="c1"># =&gt; "cat"</span>
<span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">codepoints</span>     <span class="c1"># =&gt; [ "c", "a", "t" ]</span>
<span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">sort</span>             <span class="c1"># =&gt; [ "a", "c", "t" ]</span>
</code></pre>
</div>
<p>The <code class="highlighter-rouge">|&gt;</code> notation is syntactic sugar for passing the result of a function as the first parameter of the next function. The preceding code is equivalent to</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="no">Enum</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">codepoints</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">downcase</span><span class="p">(</span><span class="sd">"</span><span class="s2">Cat"</span><span class="p">)))</span>
</code></pre>
</div>

<p>Thrilling stuff, eh?</p>

<p>Let’s image we’d just finished executing the first  line. What is our state?</p>

<p>Somewhere in memory, there’s a data structure representing the string “Cat”.   That’s the first part of our state.  The second part  is the value of the program counter. Logically, it’s pointing to the start of line 2.</p>

<p>Execute one more line.   <code class="highlighter-rouge">String.downcase</code>  is passed the string “Cat”. The result, another string containing “cat”, is stored in a different place in our computer. The PC now points to the start of line 3.</p>

<p>And so it goes. With each step, the state of the computer  changes, meaning that the state of our program changes.</p>

<p>State is not immutable.</p>

<h3 id="is-this-splitting-hairs">Is This Splitting Hairs?</h3>

<p>Yes and no.</p>

<p>Yes, because no one would argue that the state of a computer is unchanged during the execution of a program.</p>

<p>No, because people still say that immutable state is a characteristic of  functional programming. That’s wrong. Worse, that also leads us to model programming wrongly. And that’s what the rest of this post is about.</p>

<h2 id="what-is-immutable">What <em>Is</em> Immutable?</h2>
<p>Let’s get this out of the way first. In a functional program, values are immutable. Look at the following code.</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="n">person</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="sd">"</span><span class="s2">Dave"</span><span class="p">)</span>
<span class="n">debug_dump</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
<span class="n">do_something_with</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
<span class="n">debug_dump</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</code></pre>
</div>

<p>Let’s assume that <code class="highlighter-rouge">get_user_details</code> returns some structured data,
which we dump out to some log file on line two. In a language with
immutable values, that data can never be changed. We know that nothing
in the function <code class="highlighter-rouge">do_something_with</code> can change the data referenced by
the <code class="highlighter-rouge">person</code> variable, and so the debugging we write on line 4 is
guaranteed to be the same as that created on line 2.</p>

<p>If we wanted to change the information for Dave, we’d have to create
copy of Dave’s data:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="n">person1</span> <span class="o">=</span> <span class="n">change_subscription_status</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="ss">:active</span><span class="p">)</span>
</code></pre>
</div>

<p>Now we have the variable <code class="highlighter-rouge">person</code> bound to the initial value of the
Dave person, and <code class="highlighter-rouge">person1</code> references the version with a
changed subscription status.</p>

<p>If you’ve been using languages with mutable data, at this point you’ll
have intuitively created a mental picture where <code class="highlighter-rouge">person</code> and <code class="highlighter-rouge">person1</code>
reference different chunks of memory. And you might be thinking that
this is remarkably inefficient. But in an immutable world, it needn’t
be. Because the runtime knows that the original data will never be
changed, it can reuse much of it in <code class="highlighter-rouge">person1</code>. In principle, you could
have a runtime that represented new values as nothing more that a set
of changes to be applied to the original.</p>

<p>Anyway, back to state.</p>

<p>``` elixir
person = get_user_details(“Dave”)
do_something_with(person)
person1 = change_subscription_status(person, :active)
IO.inspect person1
~~~</p>

<p>Let’s represent the state using a tuple containing the pseudo program
counter and the values bound to variables.</p>

<table>
  <thead>
    <tr>
      <th>Line</th>
      <th><code class="highlighter-rouge">person</code></th>
      <th><code class="highlighter-rouge">person1</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>—</td>
      <td>—</td>
    </tr>
    <tr>
      <td>2</td>
      <td>value1</td>
      <td>—</td>
    </tr>
    <tr>
      <td>3</td>
      <td>value1</td>
      <td>—</td>
    </tr>
    <tr>
      <td>4</td>
      <td>value1</td>
      <td>value2</td>
    </tr>
  </tbody>
</table>


      </div>
    </div>
  </div>

  
    

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://pragdave.me/blog/2015/11/13/immutability.html';
      this.page.identifier = 'https://pragdave.me/blog/2015/11/13/immutability.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://pragdave.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>


  
</article>

      </main>


    </div>
    
    <footer class="footer">
  <div class="container">
    <nav class="nav nav-inline">
      <a class="nav-link active" href="/contact">Contact</a>
      <a class="nav-link" href="/privacy">Privacy</a>
      <a class="nav-link" href="/thanks">Thanks</a>
    </nav>
  </div>


</footer>


  </body>

</html>
