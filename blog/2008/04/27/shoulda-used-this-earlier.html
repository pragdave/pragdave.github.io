<!DOCTYPE html>
<html lang="en">

  




<head>
  <title>
  
     Shoulda used this earlier
  
</title>


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="
  In many ways, testing software is like going out and getting exercise. You know you should do it, and you know it does you good, but it’s also pretty easy to...
">

  <meta name="author" content="Dave Thomas (pragdave)">

  <meta property="og:description"
        content="
  In many ways, testing software is like going out and getting exercise. You know you should do it, and you know it does you good, but it’s also pretty easy to...
">
  <meta property="og:site_name"
        content="
  
     Shoulda used this earlier
  
">
  <meta property="og:type"
        content="website">
  <meta property="og:url"
        content="
  https://pragdave.me/blog/2008/04/27/shoulda-used-this-earlier.html
">
  <meta property="og:title"
        content="
  
     Shoulda used this earlier
  
">


  <meta name="twitter:card"        content="summary">
  <meta name="twitter:description" content="
  In many ways, testing software is like going out and getting exercise. You know you should do it, and you know it does you good, but it’s also pretty easy to...
">
  <meta name="twitter:url"         content="
  https://pragdave.me/blog/2008/04/27/shoulda-used-this-earlier.html
">
  <meta name="twitter:site"        content="pragdave">

  <link rel="shortcut icon"
        href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon"
        href="/assets/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="57x57"
        href="/assets/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="72x72"
        href="/assets/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="76x76"
        href="/assets/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon" sizes="114x114"
        href="/assets/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="120x120"
        href="/assets/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="144x144"
        href="/assets/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152"
        href="/assets/apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180"
        href="/assets/apple-touch-icon-180x180.png" />
  
  <title>
  
     Shoulda used this earlier
  
</title>
  <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">

  <link rel="canonical"
        href="
  https://pragdave.me/blog/2008/04/27/shoulda-used-this-earlier.html
">

  <link type="application/atom+xml" rel="alternate" href="https://pragdave.me/feed.xml" title="pragdave—the coding gnome" />

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
  


  <link type="text/css" rel="stylesheet" href="/assets/app.css">

</head>

  <script type="text/javascript" src="/assets/vendor.js"></script>
  <script type="text/javascript" src="/assets/vendor/drumknott-0.2.0.js"></script>
  <script type="text/javascript" src="/assets/application.js"></script>

  <body>

    <div class="container">
      <header class="main-header">
  <div class="row bar">
    <div class="col-xs-12 heading-box">
      <a href="/" title="Return to the main site">
        <span class="logo"></span>
      </a>
      <h1>Shoulda used this earlier</h1>

      <nav id="search-trigger" role="search">
        <button type="button"
                class="btn btn-primary"
                data-toggle="modal"
                data-target="#search-box"
                aria-label="popup search box">
          <i class="fa fa-search" ></i>
          <span class="word" >search</span>
        </button>
      </nav>

    </div>
  </div>
  <div class="row mh-slug">
    <h3 class="col-xs-12">code better • have fun</h3>
  </div>

  <div class="modal fade"
     id="search-box"
     tabindex="-1"
     role="dialog"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <form id="search-form">
          <input type="text" class="form-control"
                 placeholder="search for…"
                 id="search-text"
                 aria-describedby="search-button">
            </button>
        </form>
        <div id="search-failed" style="display: none" >
          No matches found
        </div>
        <div id="search-results" style="display: none" >
          <ul>
          </ul>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" id="search-button" class="btn btn-primary">Search</button>
      </div>
    </div>
  </div>
</div>




</header>





      <main role="main" aria-label="Content">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="row">
    <div class="col-md-4">
      <div class="related" >
        <h4>You might like:</h4>
        

<ul class="related">
  
  
  
  
  
  
  
  
  
  <li>
      <a href="/blog/2018/06/02/project-structure.html">
        <small>02 Jun 2018</small>
        Project Structure Fire
      </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  
  
  

  
  
  
  
  
  
  
  
  
  
  
  

  
  
  
  
  
  
  
  
  <li>
      <a href="/blog/2018/04/04/moving-back-to-linux.html">
        <small>04 Apr 2018</small>
        Moving Back to Linux
      </a>
  </li>
  
  
  

  
  
  
  
  
  
  
  
  <li>
      <a href="/blog/2018/01/28/dynamic-supervisors.html">
        <small>28 Jan 2018</small>
        Dynamix Supervisors replace :simple_one_for_one
      </a>
  </li>
  
  
  
  
  
</ul>

      </div>
    </div>
    <div class="col-md-8">
      <p class="post-meta">
        <time datetime="2008-04-27T00:00:00-05:00" itemprop="datePublished">Apr 27, 2008
        </time>
         | 
        
        <a href="/blog/tags#ruby" class="post-tag">ruby</a>
        
        

      </p>

      <div class="post-content" itemprop="articleBody">
        <p>In many ways, testing software is like going out and getting
exercise. You know you should do it, and you know it does you good,
but it’s also pretty easy to find an excuse to skip it (I’ll make it
up tomorrow).</p>

<p>So anything that makes testing easier is good, because it cuts down on
the excuses not to do it.</p>

<p>One thing I’ve never really liked about the conventional xUnit-style
testing frameworks was the setup and teardown structure. In these
frameworks, a test case is a class, and setup and teardown are
implemented by methods in that class. Each test is also a method, so
the basic flow is</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for each test method in the class
  run setup
  run the test method
  run teardown
end
</code></pre>
</div>

<p>Nice and simple. Each test method got the benefit of a standard
environment created by the setup method, and the teardown method got
the job of tidying up after.</p>

<p>Except… when I’m writing tests, I typically want to set up lots of
different scenarios. I’ll want A and B and C, then A and B but not C,
then A and not B, then A and D, and so on. I had two choices—write
lots of test case classes, using subclassing to inherit common setup
behavior, or write per-test method setup code (often factored out into
helpers). In the end, I almost always did the latter, And that was
tedious, and it made it harder to see the tests for the setup code.</p>

<p>I flirted with RSpec. Its spec framework seemed to have what I
wanted. But I just couldn’t get myself to enjoy using it. (I think
it’s a cat people/dog people kind of thing)</p>

<h3 id="enter-shoulda">Enter shoulda</h3>

<p>Then, a couple of weeks back, Mike Clark and Chad Fowler introduced me
to <a href="http://www.thoughtbot.com/projects/shoulda">shoulda</a>. Shoulda
isn’t a testing framework. Instead, it extends Ruby’s existing
Test::Unit framework with the idea of test_contexts_. A context is a
section of your test case where all the test methods have something in
common. At it simplest, a context could be simply used as an
annotation device (and, yes, this is a silly example):</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">context</span> <span class="s2">"My factorial method"</span> <span class="k">do</span>
  <span class="n">should</span> <span class="s2">"return 1 when passed 0"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fact</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">should</span> <span class="s2">"return 1 when passed 1"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fact</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">should</span> <span class="s2">"return 6 when passed 3"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="mi">6</span><span class="p">,</span> <span class="n">fact</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>

<p>The stuff in a context can share common setup code—just write
a <code class="highlighter-rouge">setup</code> block.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CartTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">context</span> <span class="s2">"An empty cart"</span> <span class="k">do</span>
    <span class="n">setup</span> <span class="k">do</span>
      <span class="vi">@cart</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:wilmas_empty_cart</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">should</span> <span class="s2">"have no line items"</span> <span class="k">do</span>
      <span class="n">assert_equal</span> <span class="mi">0</span><span class="p">,</span> <span class="vi">@cart</span><span class="p">.</span><span class="nf">line_items</span><span class="p">.</span><span class="nf">size</span>
    <span class="k">end</span>

    <span class="n">should</span> <span class="s2">"have a zero price"</span> <span class="k">do</span>
      <span class="n">assert_equal</span> <span class="mi">0</span><span class="p">,</span> <span class="vi">@cart</span><span class="p">.</span><span class="nf">price</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"Some other context..."</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>So now, within a single test case I can set up multiple contexts, and
each context can have its own environment.</p>

<p>But, take it back to my original problem. I often want to set up
hierarchies of related environments for my tests. The shaoulda code
handles this wonderfully, because it lets me nest contexts. For
example, I’m adding a feature to our store that gives customers some
additional information if, during checkout, their credit card
transaction was initially rejected because the address was wrong, and
was then accepted when they fixed the address. I wanted two tests, one
without the prior address error, and one with.</p>

<p>To set up this environment, I needed to set up a shopping cart, create
a dummy response from our payment gateway, and post that response to
the application. In the case of the prior address error, I also wanted
to inject an entry containing that error into the transactions
associated with the order prior to generating the response.</p>

<p>With shoulda, I simply created some nested contexts. The top level
context did the shared setup, and the inner contexts then set up
appropriate environments for their tests. It looked like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">context</span> <span class="s2">"Checking out"</span>  <span class="k">do</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@cart</span> <span class="o">=</span> <span class="n">cart_named</span><span class="p">(</span><span class="ss">:freds_full_cart</span><span class="p">)</span>
    <span class="vi">@cart</span><span class="p">.</span><span class="nf">prepare_for_store_authorize!</span>
    <span class="vi">@params</span> <span class="o">=</span> <span class="n">approved_authnet_response</span><span class="p">(</span><span class="vi">@cart</span><span class="p">)</span>
  <span class="k">end</span>                  

  <span class="n">context</span> <span class="s2">"with no AVS errors in CC transaction history"</span> <span class="k">do</span>
    <span class="n">setup</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:post_from_authnet_authorize</span><span class="p">,</span> <span class="vi">@params</span>
    <span class="k">end</span>

    <span class="n">should_redirect_to</span> <span class="s2">"{:action =&gt; :receipt}"</span>
  <span class="k">end</span> 

  <span class="n">context</span> <span class="s2">"with AVS errors in CC transaction history"</span> <span class="k">do</span>
    <span class="n">setup</span> <span class="k">do</span>
      <span class="n">avs_error</span> <span class="o">=</span> <span class="no">CcTransaction</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:response_code</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:response_reason_code</span> <span class="o">=&gt;</span> <span class="mi">27</span><span class="p">)</span>
      <span class="vi">@cart</span><span class="p">.</span><span class="nf">cc_transactions</span> <span class="o">&lt;&lt;</span> <span class="n">avs_error</span>
      <span class="n">post</span> <span class="ss">:post_from_authnet_authorize</span><span class="p">,</span> <span class="vi">@params</span>
    <span class="k">end</span>

    <span class="n">should_redirect_to</span> <span class="s2">"{:action =&gt; :explain_avs_mismatch}"</span>
  <span class="k">end</span>
<span class="k">end</span> 

</code></pre>
</div>

<p>The outer setup gets run before the execution of each of the inner
contexts. And the setup in the inner contexts gets run when running
that context. And shoulda keeps track of it all, so I get very natural
error messages if an assertion fails. For example, if the test in the
second context above fails, I’d get</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Checking out with AVS errors in CC transaction history should 
redirect to "{:action =&gt; :explain_avs_mixsmatch}". 

</code></pre>
</div>

<p>So, now, I can finally set up my hierarchies of test environments in a
natural way. It isn’t revolutionary. It’s just one less excuse for not
testing…</p>


      </div>
    </div>
  </div>

  
    

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://pragdave.me/blog/2008/04/27/shoulda-used-this-earlier.html';
      this.page.identifier = 'https://pragdave.me/blog/2008/04/27/shoulda-used-this-earlier.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://pragdave.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>


  
</article>

      </main>


    </div>
    
    <footer class="footer">
  <div class="container">
    <nav class="nav nav-inline">
      <a class="nav-link active" href="/contact">Contact</a>
      <a class="nav-link" href="/privacy">Privacy</a>
      <a class="nav-link" href="/thanks">Thanks</a>
    </nav>
  </div>


</footer>


  </body>

</html>
